# 02 — Data Model

## 2.1 Entity Overview

IronClaw persists state across **20+ tables** in two backend-interchangeable schemas (PostgreSQL and libSQL). The core domain has 7 key entities; the remaining tables support security auditing, rate limiting, search indexing, and operational bookkeeping.

---

## 2.2 Core Entities

### Conversation

Multi-channel conversation container. A conversation belongs to one channel and one user, and holds an ordered sequence of messages.

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK | TEXT PK | |
| `channel` | TEXT NOT NULL | TEXT NOT NULL | e.g. "tui", "web", "telegram" |
| `user_id` | TEXT NOT NULL | TEXT NOT NULL | |
| `thread_id` | TEXT | TEXT | Optional sub-thread identifier |
| `started_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |
| `last_activity` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | Updated on each message |
| `metadata` | JSONB DEFAULT '{}' | TEXT DEFAULT '{}' | Extensible per-channel data |

**Indexes:** `channel`, `user_id`, `last_activity`

### ConversationMessage

Individual messages within a conversation. Append-only log.

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK | TEXT PK | |
| `conversation_id` | UUID FK → conversations | TEXT FK → conversations | ON DELETE CASCADE |
| `role` | TEXT NOT NULL | TEXT NOT NULL | "user", "assistant", "system", "tool" |
| `content` | TEXT NOT NULL | TEXT NOT NULL | |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |

### AgentJob

The central work unit. Each user request that requires multi-step execution becomes a job. Jobs follow a strict state machine (see §2.4).

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK | TEXT PK | |
| `marketplace_job_id` | UUID | TEXT | Reserved for external marketplace |
| `conversation_id` | UUID FK → conversations | TEXT FK → conversations | Nullable |
| `title` | TEXT NOT NULL | TEXT NOT NULL | |
| `description` | TEXT NOT NULL | TEXT NOT NULL | |
| `category` | TEXT | TEXT | For estimation learning |
| `status` | TEXT NOT NULL | TEXT NOT NULL | See JobState enum §2.4 |
| `source` | TEXT NOT NULL | TEXT NOT NULL | Origin channel |
| `user_id` | — | TEXT NOT NULL DEFAULT 'default' | libSQL-only column |
| `project_dir` | — | TEXT | libSQL-only; sandbox working dir |
| `job_mode` | — | TEXT DEFAULT 'worker' | libSQL-only; "worker" or "claude_code" |
| `budget_amount` | NUMERIC | TEXT | Max spend cap |
| `budget_token` | TEXT | TEXT | Currency token identifier |
| `bid_amount` | NUMERIC | TEXT | Marketplace bid |
| `estimated_cost` | NUMERIC | TEXT | Pre-execution estimate |
| `estimated_time_secs` | INTEGER | INTEGER | |
| `estimated_value` | NUMERIC | TEXT | Expected output value |
| `actual_cost` | NUMERIC | TEXT | Post-execution actual |
| `actual_time_secs` | INTEGER | INTEGER | |
| `success` | BOOLEAN | INTEGER (0/1) | |
| `failure_reason` | TEXT | TEXT | |
| `stuck_since` | TIMESTAMPTZ | TEXT | Set when job enters Stuck state |
| `repair_attempts` | INTEGER DEFAULT 0 | INTEGER DEFAULT 0 | Max 3 before permanent failure |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |
| `started_at` | TIMESTAMPTZ | TEXT | |
| `completed_at` | TIMESTAMPTZ | TEXT | |

**Indexes:** `status`, `marketplace_job_id`, `conversation_id`, `stuck_since` (partial: WHERE NOT NULL)

### JobAction

Event-sourced audit trail of every tool execution within a job. Each action records raw output, sanitized output, and any safety warnings.

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK | TEXT PK | |
| `job_id` | UUID FK → agent_jobs | TEXT FK → agent_jobs | ON DELETE CASCADE |
| `sequence_num` | INTEGER NOT NULL | INTEGER NOT NULL | UNIQUE with job_id |
| `tool_name` | TEXT NOT NULL | TEXT NOT NULL | |
| `input` | JSONB NOT NULL | TEXT NOT NULL | Tool parameters |
| `output_raw` | TEXT | TEXT | Before sanitization |
| `output_sanitized` | JSONB | TEXT | After safety layer processing |
| `sanitization_warnings` | JSONB | TEXT | Warnings generated by sanitizer |
| `cost` | NUMERIC | TEXT | Token cost for this action |
| `duration_ms` | INTEGER | INTEGER | |
| `success` | BOOLEAN NOT NULL | INTEGER NOT NULL | |
| `error_message` | TEXT | TEXT | |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |

**Unique constraint:** `(job_id, sequence_num)` — guarantees ordered audit trail per job.

### MemoryDocument

Flexible path-based persistent files forming a virtual filesystem. Documents are chunked for hybrid search (FTS + vector).

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK DEFAULT gen_random_uuid() | TEXT PK | |
| `user_id` | TEXT NOT NULL | TEXT NOT NULL | |
| `agent_id` | UUID | TEXT | NULL = shared across agents |
| `path` | TEXT NOT NULL | TEXT NOT NULL | e.g. "context/vision.md" |
| `content` | TEXT NOT NULL | TEXT NOT NULL | Full document body |
| `metadata` | JSONB DEFAULT '{}' | TEXT DEFAULT '{}' | |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |
| `updated_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | Auto-updated via trigger |

**Unique constraint:** `(user_id, agent_id, path)` — one file per path per user-agent pair.

**Well-known paths:**

| Path | Purpose |
|------|---------|
| `IDENTITY.md` | Agent identity (injected into system prompt) |
| `SOUL.md` | Core values and principles (injected into system prompt) |
| `AGENTS.md` | Behavior instructions (injected into system prompt) |
| `USER.md` | User context (injected into system prompt) |
| `MEMORY.md` | Long-term curated memory |
| `HEARTBEAT.md` | Periodic execution checklist |
| `daily/*.md` | Daily logs |
| `context/*.md` | Context directory |

### MemoryChunk

Search-optimized fragments of memory documents. Each chunk is ~800 tokens with 15% overlap for context continuity.

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK DEFAULT gen_random_uuid() | TEXT NOT NULL UNIQUE | libSQL uses `_rowid` as true PK |
| `document_id` | UUID FK → memory_documents | TEXT FK → memory_documents | ON DELETE CASCADE |
| `chunk_index` | INT NOT NULL | INTEGER NOT NULL | Position within document |
| `content` | TEXT NOT NULL | TEXT NOT NULL | Chunk text |
| `content_tsv` | TSVECTOR (generated, stored) | — | PG only; auto-generated from content |
| `embedding` | VECTOR(1536) | F32_BLOB(1536) | 1536 dims for text-embedding-3-small |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |

**Unique constraint:** `(document_id, chunk_index)`

**Search indexes:**
- **PG:** GIN on `content_tsv`, HNSW on `embedding` (m=16, ef_construction=64, cosine distance)
- **libSQL:** FTS5 virtual table `memory_chunks_fts` with sync triggers, `libsql_vector_idx` on `embedding`

### Routine

Scheduled or event-driven automated tasks with guardrails and notification config.

| Column | PG Type | libSQL Type | Constraints |
|--------|---------|-------------|-------------|
| `id` | UUID PK | TEXT PK | |
| `name` | TEXT NOT NULL | TEXT NOT NULL | UNIQUE per user |
| `description` | TEXT | TEXT DEFAULT '' | |
| `user_id` | TEXT NOT NULL | TEXT NOT NULL | |
| `enabled` | BOOLEAN | INTEGER DEFAULT 1 | |
| `trigger_type` | TEXT NOT NULL | TEXT NOT NULL | "cron", "event", "webhook", "manual" |
| `trigger_config` | JSONB | TEXT NOT NULL | Serialized Trigger variant |
| `action_type` | TEXT NOT NULL | TEXT NOT NULL | "lightweight" or "full_job" |
| `action_config` | JSONB | TEXT NOT NULL | Serialized RoutineAction |
| `cooldown_secs` | INTEGER | INTEGER DEFAULT 300 | Min seconds between runs |
| `max_concurrent` | INTEGER | INTEGER DEFAULT 1 | |
| `dedup_window_secs` | INTEGER | INTEGER | Optional deduplication |
| `notify_channel` | TEXT | TEXT | NULL = broadcast |
| `notify_user` | TEXT | TEXT DEFAULT 'default' | |
| `notify_on_success` | BOOLEAN | INTEGER DEFAULT 0 | |
| `notify_on_failure` | BOOLEAN | INTEGER DEFAULT 1 | |
| `notify_on_attention` | BOOLEAN | INTEGER DEFAULT 1 | |
| `state` | JSONB | TEXT DEFAULT '{}' | Persistent state across runs |
| `last_run_at` | TIMESTAMPTZ | TEXT | |
| `next_fire_at` | TIMESTAMPTZ | TEXT | Computed from trigger schedule |
| `run_count` | INTEGER DEFAULT 0 | INTEGER DEFAULT 0 | |
| `consecutive_failures` | INTEGER DEFAULT 0 | INTEGER DEFAULT 0 | |
| `created_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |
| `updated_at` | TIMESTAMPTZ DEFAULT NOW() | TEXT DEFAULT datetime('now') | |

**Trigger types:**

| Variant | Config Fields | Example |
|---------|--------------|---------|
| `Cron` | `schedule: String` | `"0 9 * * MON-FRI"`, `"every 2h"` |
| `Event` | `channel: Option<String>`, `pattern: String` | Pattern: regex matched against messages |
| `Webhook` | `path: Option<String>`, `secret: Option<String>` | HMAC-validated external triggers |
| `Manual` | (none) | Triggered via tool call or API only |

**Action types:**

| Variant | Config Fields | Purpose |
|---------|--------------|---------|
| `Lightweight` | `prompt`, `context_paths: Vec<String>`, `max_tokens: u32` (default 4096) | Quick check using memory context |
| `FullJob` | `title`, `description`, `max_iterations: u32` (default 10) | Spawn a complete agent job |

---

## 2.3 Supporting Entities

### Secret

Encrypted credential storage. Values are AES-256-GCM encrypted at rest. Injected into HTTP requests by the network proxy — never exposed to container processes.

| Column | Type | Notes |
|--------|------|-------|
| `id` | TEXT PK | |
| `user_id` | TEXT NOT NULL | |
| `name` | TEXT NOT NULL | UNIQUE per user |
| `encrypted_value` | BLOB NOT NULL | AES-256-GCM ciphertext |
| `key_salt` | BLOB NOT NULL | Per-secret key derivation salt |
| `provider` | TEXT | e.g. "openai", "github" |
| `expires_at` | TEXT | Optional TTL |
| `usage_count` | INTEGER DEFAULT 0 | Incremented on each injection |

### WasmTool

Registry of WASM-sandboxed tools with binary integrity verification.

| Column | Type | Notes |
|--------|------|-------|
| `id` | TEXT PK | |
| `user_id` | TEXT NOT NULL | |
| `name` | TEXT NOT NULL | |
| `version` | TEXT DEFAULT '1.0.0' | UNIQUE with (user_id, name, version) |
| `wasm_binary` | BLOB NOT NULL | Compiled WASM module |
| `binary_hash` | BLOB NOT NULL | BLAKE3 hash; verified on every load |
| `parameters_schema` | TEXT (JSON) | Tool input schema |
| `trust_level` | TEXT DEFAULT 'user' | `system` / `verified` / `user` |
| `status` | TEXT DEFAULT 'active' | `active` / `disabled` / `quarantined` |

### ToolCapabilities

Per-tool security and rate-limit policy. Linked 1:1 with a WasmTool.

| Column | Type | Notes |
|--------|------|-------|
| `wasm_tool_id` | TEXT FK → wasm_tools | UNIQUE (1:1) |
| `http_allowlist` | TEXT (JSON array) | Endpoint patterns tool may call |
| `allowed_secrets` | TEXT (JSON array) | Secret names tool may use |
| `requests_per_minute` | INTEGER DEFAULT 60 | |
| `requests_per_hour` | INTEGER DEFAULT 1000 | |
| `max_request_body_bytes` | INTEGER DEFAULT 1,048,576 | 1 MB |
| `max_response_body_bytes` | INTEGER DEFAULT 10,485,760 | 10 MB |
| `workspace_read_prefixes` | TEXT (JSON array) | Allowed memory paths |
| `http_timeout_secs` | INTEGER DEFAULT 30 | |

### Other Tables

| Table | Purpose | Key Details |
|-------|---------|-------------|
| `llm_calls` | Token/cost tracking per LLM invocation | FK to both job and conversation; tracks provider, model, token counts, cost |
| `estimation_snapshots` | Learning data for cost/time estimator | Records predicted vs actual cost, time, and value per job category |
| `repair_attempts` | Self-repair audit trail | Diagnosis + action taken + success for stuck-job recovery |
| `dynamic_tools` | Agent-built tools (runtime) | Source code, schema, sandbox config, success/failure counters |
| `tool_failures` | Tool reliability tracking | Error count, last error, repair attempts; drives self-repair decisions |
| `heartbeat_state` | Periodic execution state | Per-user; tracks next_run, consecutive_failures, last check results |
| `routine_runs` | Routine execution history | Status (running/ok/attention/failed), token usage, linked job_id |
| `job_events` | Real-time job event stream | Autoincrement ID for ordered streaming; type + JSON data |
| `settings` | Per-user key-value config | Composite PK (user_id, key); value is JSON |
| `leak_detection_patterns` | Secret pattern definitions | 18 pre-seeded patterns (see §2.5) |
| `leak_detection_events` | Leak detection audit log | Links pattern, tool, user, action taken |
| `secret_usage_log` | Credential injection audit | Tracks which tool used which secret against which host |
| `tool_rate_limit_state` | Per-tool sliding window counters | Minute + hour windows per (tool, user) pair |

---

## 2.4 State Machines

### JobState

```
                    ┌──────────┐
                    │ Pending  │
                    └────┬─────┘
                         │
              ┌──────────▼──────────┐
    ┌─────────│    InProgress       │─────────┐
    │         └──────┬──────┬───────┘         │
    │                │      │                 │
    │         ┌──────▼──┐ ┌─▼─────┐    ┌─────▼─────┐
    │         │Completed│ │ Stuck │    │  Failed   │
    │         └────┬────┘ └───┬───┘    │ (terminal)│
    │              │          │        └───────────┘
    │         ┌────▼─────┐   │ recovery
    │         │Submitted │   │──► InProgress
    │         └────┬─────┘   │
    │              │         │──► Failed
    │         ┌────▼─────┐   │
    │         │ Accepted │   └──► Cancelled
    │         │(terminal)│
    │         └──────────┘
    │
    └──► Cancelled (terminal)
```

**Valid transitions:**

| From | To | Trigger |
|------|----|---------|
| Pending | InProgress | Worker picks up job |
| Pending | Cancelled | User cancels |
| InProgress | Completed | All tool calls succeed |
| InProgress | Failed | Unrecoverable error |
| InProgress | Stuck | No progress for 5 minutes |
| InProgress | Cancelled | User cancels |
| Completed | Submitted | Job output submitted |
| Completed | Failed | Submission error |
| Submitted | Accepted | Review approved |
| Submitted | Failed | Review rejected |
| Stuck | InProgress | Self-repair succeeds (max 3 attempts) |
| Stuck | Failed | Repair exhausted |
| Stuck | Cancelled | User cancels |

### ThreadState

```
    ┌────────┐
    │  Idle  │◄─────────────────────┐
    └───┬────┘                      │
        │ user message              │ turn completes
   ┌────▼───────┐            ┌──────┴──────┐
   │ Processing │───────────►│  Completed  │
   └────┬───────┘            └─────────────┘
        │ tool needs approval
   ┌────▼──────────────┐
   │ AwaitingApproval  │
   └────┬──────────────┘
        │ approved/denied
        ▼
    Processing (resumes)
```

Additional terminal: `Interrupted` — set when the thread is externally stopped.

### TurnState

| State | Meaning |
|-------|---------|
| `Processing` | Turn is actively being handled |
| `Completed` | Turn finished successfully |
| `Failed` | Turn encountered an error |
| `Interrupted` | Turn was externally stopped |

### RoutineRun Status

| State | Meaning |
|-------|---------|
| `Running` | Execution in progress |
| `Ok` | Completed with no actionable findings |
| `Attention` | Completed with findings requiring notification |
| `Failed` | Execution error |

### WasmTool Status

| State | Meaning | Transition Cause |
|-------|---------|-----------------|
| `Active` | Available for execution | Initial state; restored after repair |
| `Disabled` | Manually or automatically disabled | Admin action or repeated failures |
| `Quarantined` | Suspected malicious behavior | Leak detection or policy violation |

---

## 2.5 Seed Data

The `leak_detection_patterns` table is pre-populated with 18 patterns:

| Pattern Name | Severity | Action | What It Catches |
|-------------|----------|--------|-----------------|
| `openai_api_key` | critical | block | `sk-[a-zA-Z0-9]{20,}` |
| `anthropic_api_key` | critical | block | `sk-ant-[a-zA-Z0-9-]{20,}` |
| `aws_access_key` | critical | block | `AKIA[0-9A-Z]{16}` |
| `aws_secret_key` | high | block | AWS secret access keys |
| `github_token` | critical | block | `ghp_`, `gho_`, `ghs_`, `ghr_` prefixed |
| `github_fine_grained_pat` | critical | block | `github_pat_` prefixed |
| `stripe_api_key` | critical | block | `sk_live_`, `sk_test_` prefixed |
| `nearai_session` | critical | block | `sess_` prefixed tokens |
| `bearer_token` | high | redact | Generic Bearer tokens in headers |
| `pem_private_key` | critical | block | `-----BEGIN.*PRIVATE KEY-----` |
| `ssh_private_key` | critical | block | `-----BEGIN OPENSSH PRIVATE KEY-----` |
| `google_api_key` | high | block | `AIza` prefixed |
| `slack_token` | high | block | `xoxb-`, `xoxp-`, `xoxs-` prefixed |
| `discord_token` | high | block | Discord bot tokens |
| `twilio_api_key` | high | block | `SK` + 32 hex chars |
| `sendgrid_api_key` | high | block | `SG.` prefixed |
| `mailchimp_api_key` | medium | block | Mailchimp key pattern |
| `high_entropy_hex` | medium | warn | Long hex strings (potential secrets) |

---

## 2.6 Entity-Relationship Diagram

```mermaid
erDiagram
    conversations {
        UUID id PK
        TEXT channel
        TEXT user_id
        TEXT thread_id
        TIMESTAMPTZ started_at
        TIMESTAMPTZ last_activity
        JSONB metadata
    }

    conversation_messages {
        UUID id PK
        UUID conversation_id FK
        TEXT role
        TEXT content
        TIMESTAMPTZ created_at
    }

    agent_jobs {
        UUID id PK
        UUID conversation_id FK
        TEXT title
        TEXT description
        TEXT status
        TEXT source
        NUMERIC estimated_cost
        NUMERIC actual_cost
        INTEGER repair_attempts
        TIMESTAMPTZ stuck_since
        TIMESTAMPTZ created_at
        TIMESTAMPTZ started_at
        TIMESTAMPTZ completed_at
    }

    job_actions {
        UUID id PK
        UUID job_id FK
        INTEGER sequence_num
        TEXT tool_name
        JSONB input
        TEXT output_raw
        JSONB output_sanitized
        BOOLEAN success
        INTEGER duration_ms
    }

    job_events {
        INTEGER id PK
        TEXT job_id FK
        TEXT event_type
        TEXT data
    }

    memory_documents {
        UUID id PK
        TEXT user_id
        UUID agent_id
        TEXT path
        TEXT content
        JSONB metadata
        TIMESTAMPTZ updated_at
    }

    memory_chunks {
        UUID id PK
        UUID document_id FK
        INTEGER chunk_index
        TEXT content
        TSVECTOR content_tsv
        VECTOR embedding
    }

    routines {
        UUID id PK
        TEXT name
        TEXT user_id
        TEXT trigger_type
        JSONB trigger_config
        TEXT action_type
        JSONB action_config
        INTEGER cooldown_secs
        BOOLEAN enabled
        TIMESTAMPTZ next_fire_at
    }

    routine_runs {
        UUID id PK
        UUID routine_id FK
        TEXT status
        TEXT trigger_type
        TIMESTAMPTZ started_at
        TIMESTAMPTZ completed_at
        UUID job_id FK
    }

    secrets {
        UUID id PK
        TEXT user_id
        TEXT name
        BLOB encrypted_value
        BLOB key_salt
        TEXT provider
    }

    wasm_tools {
        UUID id PK
        TEXT user_id
        TEXT name
        TEXT version
        BLOB wasm_binary
        BLOB binary_hash
        TEXT trust_level
        TEXT status
    }

    tool_capabilities {
        UUID id PK
        UUID wasm_tool_id FK
        TEXT http_allowlist
        TEXT allowed_secrets
        INTEGER requests_per_minute
        INTEGER requests_per_hour
    }

    dynamic_tools {
        UUID id PK
        TEXT name
        TEXT description
        TEXT code
        TEXT status
        UUID created_by_job_id FK
    }

    llm_calls {
        UUID id PK
        UUID job_id FK
        UUID conversation_id FK
        TEXT provider
        TEXT model
        INTEGER input_tokens
        INTEGER output_tokens
        NUMERIC cost
    }

    estimation_snapshots {
        UUID id PK
        UUID job_id FK
        TEXT category
        NUMERIC estimated_cost
        NUMERIC actual_cost
    }

    repair_attempts {
        UUID id PK
        TEXT target_type
        UUID target_id
        TEXT diagnosis
        BOOLEAN success
    }

    heartbeat_state {
        UUID id PK
        TEXT user_id
        BOOLEAN enabled
        INTEGER interval_seconds
        TIMESTAMPTZ next_run
    }

    settings {
        TEXT user_id PK
        TEXT key PK
        TEXT value
    }

    tool_failures {
        TEXT tool_name PK
        INTEGER error_count
        TEXT last_error
        INTEGER repair_attempts
    }

    leak_detection_patterns {
        UUID id PK
        TEXT name
        TEXT pattern
        TEXT severity
        TEXT action
    }

    leak_detection_events {
        UUID id PK
        UUID pattern_id FK
        UUID wasm_tool_id FK
        TEXT action_taken
    }

    secret_usage_log {
        UUID id PK
        UUID secret_id FK
        UUID wasm_tool_id FK
        TEXT target_host
    }

    tool_rate_limit_state {
        UUID id PK
        UUID wasm_tool_id FK
        TEXT user_id
        INTEGER minute_count
        INTEGER hour_count
    }

    %% Relationships
    conversations ||--o{ conversation_messages : "has"
    conversations ||--o{ agent_jobs : "spawns"
    conversations ||--o{ llm_calls : "tracks"
    agent_jobs ||--o{ job_actions : "records"
    agent_jobs ||--o{ job_events : "streams"
    agent_jobs ||--o{ llm_calls : "incurs"
    agent_jobs ||--o{ estimation_snapshots : "estimates"
    agent_jobs ||--o| dynamic_tools : "builds"
    memory_documents ||--o{ memory_chunks : "chunked into"
    routines ||--o{ routine_runs : "executes"
    routine_runs ||--o| agent_jobs : "spawns"
    wasm_tools ||--|| tool_capabilities : "governed by"
    wasm_tools ||--o{ tool_rate_limit_state : "rate-limited"
    wasm_tools ||--o{ secret_usage_log : "audited"
    wasm_tools ||--o{ leak_detection_events : "flagged in"
    secrets ||--o{ secret_usage_log : "used by"
    leak_detection_patterns ||--o{ leak_detection_events : "triggers"
```

---

## 2.7 Cross-Backend Differences

| Concern | PostgreSQL | libSQL |
|---------|-----------|--------|
| **UUIDs** | Native `UUID` type | `TEXT` (application-generated) |
| **Timestamps** | `TIMESTAMPTZ` | `TEXT` (ISO-8601 strings) |
| **JSON** | `JSONB` (binary, indexable) | `TEXT` (plain JSON strings) |
| **Booleans** | Native `BOOLEAN` | `INTEGER` (0/1) |
| **Decimals** | `NUMERIC` | `TEXT` (string representation) |
| **Arrays** | `TEXT[]` | `TEXT` (JSON array string) |
| **FTS** | `tsvector` + GIN (generated column) | FTS5 virtual table + sync triggers |
| **Vector search** | `pgvector` HNSW (m=16, ef=64) | `libsql_vector_idx` on `F32_BLOB` |
| **JSON update** | `jsonb_set` (path-targeted) | `json_patch` (RFC 7396 merge patch) |
| **Auto-timestamp** | PL/pgSQL trigger function | `AFTER UPDATE` trigger |
| **Partial indexes** | Supported (`WHERE stuck_since IS NOT NULL`) | Not supported; plain index instead |
| **Extra columns** | — | `user_id`, `project_dir`, `job_mode` on agent_jobs |
